<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LRCタイムスタンプ作成ツール（β）</title>
  <style>
    * {
      box-sizing: border-box;
    }
    :root {
      --ink: #0a2540;
      --muted: #6b7a90;
      --line: rgba(10, 37, 64, 0.12);
      --brand: #1b6ef3;
      --brand-2: #2cc2ff;
      --bg: #f5f9ff;
      --panel: rgba(255, 255, 255, 0.85);
      --shadow: 0 20px 60px rgba(12, 44, 82, 0.15);
    }
    body {
      margin: 0;
      font-family: "Poppins", "BIZ UDPGothic", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      color: var(--ink);
      background: #f2f2f2;
      min-height: 100vh;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 3.5rem;
    }
    header {
      margin-bottom: 2rem;
    }
    h1 {
      margin: 0.4rem 0 0.6rem;
      font-size: clamp(1.8rem, 2.4vw, 2.6rem);
      line-height: 1.2;
    }
    .sub {
      color: var(--muted);
      margin: 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.2rem;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 1.2rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.6rem;
    }
    input[type="file"] {
      display: block;
      width: 100%;
      padding: 0.65rem 0.8rem;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
    }
    textarea {
      width: 100%;
      height: 140px;
      margin-top: 0.6rem;
      padding: 0.9rem;
      border-radius: 14px;
      border: 1px solid var(--line);
      font-size: 0.95rem;
      resize: vertical;
      background: #fff;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      align-items: center;
      margin-top: 1rem;
    }
    button {
      border: none;
      padding: 0.7rem 1.2rem;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    button:active {
      transform: scale(0.98);
    }
    .btn-primary {
      color: #fff;
      background: linear-gradient(120deg, var(--brand) 0%, var(--brand-2) 100%);
      box-shadow: 0 10px 20px rgba(27, 110, 243, 0.25);
    }
    .btn-secondary {
      color: var(--ink);
      background: #fff;
      border: 1px solid var(--line);
    }
    .player {
      width: 100%;
      margin-top: 0.6rem;
    }
    .lyrics-container {
      max-height: 360px;
      overflow-y: auto;
      border: 1px solid var(--line);
      padding: 0.6rem;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.7);
    }
    .lyrics-line {
      margin: 0.25rem 0;
      padding: 0.4rem 0.6rem;
      display: flex;
      gap: 0.8rem;
      align-items: baseline;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }
    .lyrics-line:hover {
      background: rgba(27, 110, 243, 0.08);
      transform: translateX(2px);
    }
    .timestamp {
      color: var(--brand);
      font-weight: 600;
      min-width: 92px;
      font-variant-numeric: tabular-nums;
    }
    .highlight {
      background: rgba(27, 110, 243, 0.16);
      box-shadow: inset 0 0 0 1px rgba(27, 110, 243, 0.22);
    }
    .mark-btn {
      position: sticky;
      top: 0.4rem;
      z-index: 1;
    }
    .hint {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 0.6rem;
    }
    .footer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-top: 1.2rem;
    }
    @media (max-width: 720px) {
      .footer-actions {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>LRCタイムスタンプ作成ツール（β）</h1>
      <p class="sub">音源と歌詞を読み込んで、クリックでタイムスタンプを付与。</p>
    </header>

    <div class="grid">
      <section class="card">
        <label>音楽ファイル（またはmp4動画）を選択</label>
        <input type="file" id="audioInput" accept="audio/*,video/mp4" />

        <div class="hint">対応形式: MP3 / WAV / MP4 など</div>

        <label style="margin-top: 1rem;">歌詞ファイル (.txt) を選択</label>
        <input type="file" id="lyricsInput" accept=".txt" />

        <label style="margin-top: 1rem;">または歌詞を直接貼り付け</label>
        <textarea id="lyricsTextarea" placeholder="ここに歌詞を貼り付けてください"></textarea>
        <div class="actions">
          <button class="btn-secondary" onclick="loadLyricsFromTextarea()">貼り付けた歌詞を読み込む</button>
        </div>
      </section>

      <section class="card">
        <label>再生コントロール</label>
        <audio class="player" id="audioPlayer" controls></audio>

        <div class="actions">
          <button class="btn-secondary" onclick="seekAudio(-5)">-5秒</button>
          <button class="btn-secondary" onclick="seekAudio(5)">+5秒</button>
          <button class="btn-primary mark-btn" id="markBtn">現在の時間を記録</button>
        </div>

        <div class="hint">クリックで行を選択し、タイムスタンプを順番に記録します。</div>
      </section>
    </div>

    <section class="card" style="margin-top: 1.4rem;">
      <label>歌詞タイムライン</label>
      <div class="lyrics-container" id="lyricsContainer"></div>
      <div class="footer-actions">
        <div class="hint">行をクリックして記録対象を切り替えできます。</div>
        <button class="btn-primary" id="downloadBtn">LRCファイルをダウンロード</button>
      </div>
    </section>
  </div>

  <script>
    const audio = document.getElementById("audioPlayer");
    const audioInput = document.getElementById("audioInput");
    const lyricsInput = document.getElementById("lyricsInput");
    const lyricsTextarea = document.getElementById("lyricsTextarea");
    const lyricsContainer = document.getElementById("lyricsContainer");
    const downloadBtn = document.getElementById("downloadBtn");
    const markBtn = document.getElementById("markBtn");

    let lines = [];
    let currentLine = 0;

    audioInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        audio.src = URL.createObjectURL(file);
      }
    });

    lyricsInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        loadLyrics(reader.result);
      };
      reader.readAsText(file);
    });

    function loadLyricsFromTextarea() {
      const text = lyricsTextarea.value;
      if (text.trim()) {
        loadLyrics(text);
      }
    }

    function loadLyrics(rawText) {
      const textLines = rawText.split("\n");
      lyricsContainer.innerHTML = "";
      lines = textLines.map((text, index) => ({ text, time: "", index }));

      lines.forEach((line, i) => {
        const div = document.createElement("div");
        div.className = "lyrics-line";
        div.id = `line-${i}`;

        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = "[--:--.--]";

        const textSpan = document.createElement("span");
        textSpan.textContent = line.text;

        div.appendChild(timeSpan);
        div.appendChild(textSpan);

        div.addEventListener("click", () => {
          currentLine = i;
          highlightCurrent();
        });

        lyricsContainer.appendChild(div);
      });
      highlightCurrent();
    }

    markBtn.addEventListener("click", () => {
      if (lines.length === 0 || currentLine >= lines.length) return;
      const currentTime = audio.currentTime;
      const formattedTime = formatTime(currentTime);
      lines[currentLine].time = formattedTime;
      const timeSpan = document.querySelector(`#line-${currentLine} .timestamp`);
      if (timeSpan) timeSpan.textContent = formattedTime;
      currentLine++;
      highlightCurrent();
    });

    function formatTime(seconds) {
      const min = String(Math.floor(seconds / 60)).padStart(2, "0");
      const sec = String(Math.floor(seconds % 60)).padStart(2, "0");
      const ms = String(Math.floor((seconds % 1) * 100)).padStart(2, "0");
      return `[${min}:${sec}.${ms}]`;
    }

    function highlightCurrent() {
      lines.forEach((line, i) => {
        const div = document.getElementById(`line-${i}`);
        if (div) {
          div.className = "lyrics-line" + (i === currentLine ? " highlight" : "");
        }
      });
    }

    function seekAudio(seconds) {
      audio.currentTime = Math.max(0, audio.currentTime + seconds);
    }

    downloadBtn.addEventListener("click", () => {
      const lrcText = lines.map((line) => `${line.time || "[00:00.00]"}${line.text}`).join("\n");

      const blob = new Blob([lrcText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "lyrics.lrc";
      a.click();

      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
